<?xml version="1.0" encoding="UTF-8"?>
<process name="EDE_Cloudwatch_SkipProcessedFiles">

  <rule name="FILE_NOT_PROCESSED">
    <condition>not(string(/ProcessData/result/row/FILENAME))</condition>
  </rule>

  <sequence name="MainSequence">

    <!-- STEP 1: Collect Files -->
    <operation name="CollectFiles">
      <participant name="E5FileSystem"/>
      <output message="FileSystemInputMessage">
        <assign to="Action">FS_COLLECT</assign>
        <assign to="collectionFolder">/sfgdata/documents/s3temp</assign>
        <assign to="fileModTimeThreshold">10</assign>
        <assign to="deleteAfterCollect">false</assign>
        <assign to="thresholdWait">true</assign>
        <assign to="filter">*_CyberLogs.json</assign>
        <assign to="collectMultiple">true</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

    <!-- STEP 2: Initialize counts and assign first file -->
    <assign to="FSA_DocumentCount" from="count(//*[starts-with(name(),'FSA_Document')])"/>
    <assign to="FILE_COUNT">1</assign>
    <assign to="PrimaryDocument" from="//*[starts-with(name(),'FSA_Document')][position()=1]/@SCIObjectID"/>
    <assign to="DocumentName" from="/ProcessData/PrimaryDocument/DocumentName/text()"/>
    <assign to="current_filename" from="/ProcessData/DocumentName/DocumentName/text()"/>
    <assign to="safe_filename" from="concat('sfg_log_1.json')"/>

    <!-- STEP 3: DB Check -->
    <operation name="CheckIfProcessed">
      <participant name="LightweightJDBCAdapterQuery"/>
      <output message="LightweightJDBCAdapterTypeInputMessage">
        <assign to="param1" from="/ProcessData/current_filename"/>
        <assign to="paramtype1">String</assign>
        <assign to="pool">oraclePool</assign>
        <assign to="query_type">SELECT</assign>
        <assign to="row_name">row</assign>
        <assign to="result_name">result</assign>
        <assign to="sql">
          SELECT FILENAME FROM process_logs 
          WHERE TRIM(LOWER(FILENAME)) = TRIM(LOWER(?))
        </assign>
        <assign to="from">#</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="DocToDOM(PrimaryDocument)"/>
      </input>
    </operation>

    <!-- STEP 4: Conditional processing for new file -->
    <if ref="FILE_NOT_PROCESSED">
      <sequence name="IfNewFile">
  
        <!-- Extract File -->
        <operation name="ExtractFile">
          <participant name="E5FileSystem"/>
          <output message="FileSystemInputMessage">
            <assign to="Action">FS_EXTRACT</assign>
            <assign to="assignedFilename" from="/ProcessData/safe_filename"/>
            <assign to="extractionFolder">/sfg/sterlingintegrator/install/cloudwatch</assign>
            <assign to="bootstrap">false</assign>
          </output>
          <input message="inmsg">
            <assign to="." from="PrimaryDocument"/>
          </input>
        </operation>
  
        <!-- Insert Log into DB -->
        <operation name="InsertLog">
          <participant name="LightweightJDBCAdapterQuery"/>
          <output message="LightweightJDBCAdapterTypeInputMessage">
            <assign to="param1" from="/ProcessData/current_filename"/>
            <assign to="paramtype1">String</assign>
            <assign to="pool">oraclePool</assign>
            <assign to="query_type">OTHER</assign>
            <assign to="sql">
              INSERT INTO process_logs (FILENAME) VALUES(?)
            </assign>
            <assign to="from">#</assign>
          </output>
          <input message="inmsg">
            <assign to="." from="*"/>
          </input>
        </operation>
  
        <!-- Move File to Archive -->
        <operation name="ArchiveFile">
          <participant name="E5FileSystem"/>
          <output message="FileSystemInputMessage">
            <assign to="Action">FS_MOVE</assign>
            <assign to="sourceFolder">/sfgdata/documents/s3temp</assign>
            <assign to="targetFolder">/sfgdata/documents/archive</assign>
            <assign to="filePattern" from="/ProcessData/current_filename"/>
          </output>
          <input message="inmsg">
            <assign to="." from="*"/>
          </input>
        </operation>
  
      </sequence>
    </if>

    <!-- STEP 5: Write Success Flag -->
    <operation name="WriteSuccessFlag">
      <participant name="E5FileSystem"/>
      <output message="FileSystemInputMessage">
        <assign to="Action">FS_WRITE</assign>
        <assign to="targetFolder">/sfg/sterlingintegrator/install/cloudwatch</assign>
        <assign to="assignedFilename">success.flag</assign>
        <assign to="fileContents">File processed successfully</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

  </sequence>

</process>