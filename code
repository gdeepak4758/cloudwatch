<?xml version="1.0" encoding="UTF-8"?>
<process name="EDE_Cloudwatch_CollectAndAssign">

  <rule name="FILE_NOT_PROCESSED">
    <condition>string(/ProcessData/result/row/FILENAME/text()) != string(/ProcessData/current_filename/text())</condition>
  </rule>

  <sequence name="MainSequence">

    <!-- STEP 1: Collect Files -->
    <operation name="CollectFiles">
      <participant name="E5FileSystem"/>
      <output message="FileSystemInputMessage">
        <assign to="Action">FS_COLLECT</assign>
        <assign to="collectionFolder">/sfgdata/documents/s3temp</assign>
        <assign to="fileModTimeThreshold">10</assign>
        <assign to="deleteAfterCollect">false</assign>
        <assign to="thresholdWait">true</assign>
        <assign to="filter">*_CyberLogs.json</assign>
        <assign to="collectMultiple">true</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

    <!-- STEP 2: Count Documents -->
    <assign to="FSA_DocumentCount" from="count(//*[starts-with(name(),'FSA_Document')])"/>
    <assign to="FILE_COUNT">1</assign>

    <!-- STEP 2: Assign first file -->
    <assign to="PrimaryDocument" from="//*[starts-with(name(),'FSA_Document')][position()=1]/@SCIObjectID"/>
    <assign to="DocumentName" from="/ProcessData/PrimaryDocument/DocumentName/text()"/>
    <assign to="current_filename" from="/ProcessData/DocumentName/DocumentName/text()"/>
    <assign to="safe_filename" from="concat('sfg_log_1.json')"/>

    <!-- Log assignment complete -->
    <operation name="LogInfo">
      <participant name="BPLogger"/>
      <output message="BPLoggerMessage">
        <assign to="logLevel">INFO</assign>
        <assign to="message" from="concat('File assigned: ', /ProcessData/current_filename)"/>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

  </sequence>

</process>