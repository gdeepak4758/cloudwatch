<?xml version="1.0" encoding="UTF-8"?>
<process name="EDE_Cloudwatch_Process_Validated">

  <!-- Rules -->
  <rule name="HAS_MORE_FILES">
    <condition>number(/ProcessData/FILE_COUNT) &lt;= number(/ProcessData/FSA_DocumentCount)</condition>
  </rule>

  <rule name="FILE_NOT_PROCESSED">
    <condition>not(/ProcessData/result/row)</condition>
  </rule>

  <sequence name="MainSequence">

    <operation name="CollectFiles">
      <participant name="E5FileSystem"/>
      <output message="FileSystemInputMessage">
        <assign to="." from="*"/>
        <assign to="Action">FS_COLLECT</assign>
        <assign to="collectionFolder">/sfgdata/documents/s3temp</assign>
        <assign to="fileModTimeThreshold">10</assign>
        <assign to="deleteAfterCollect">false</assign>
        <assign to="thresholdWait">true</assign>
        <assign to="filter">*_CyberLogs.json</assign>
        <assign to="maxThreads">10</assign>
        <assign to="collectMultiple">true</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

    <assign to="FSA_DocumentCount" from="count(//*[starts-with(name(),'FSA_Document')])"/>
    <assign to="FILE_COUNT">1</assign>

    <choice name="LoopControl">
      <select>
        <case ref="HAS_MORE_FILES" activity="ProcessFile"/>
      </select>
    </choice>

  </sequence>

  <sequence name="ProcessFile">
    <!-- Directly get document metadata -->
    <assign to="PrimaryDocument" from="//*[starts-with(name(),'FSA_Document')][position()=/ProcessData/FILE_COUNT]/@SCIObjectID"/>
    <assign to="current_filename" from="//*[starts-with(name(),'FSA_Document')][position()=/ProcessData/FILE_COUNT]/@DocumentName"/>
    <assign to="safe_filename" from="concat('sfg_log_', string(/ProcessData/FILE_COUNT), '.json')"/>

    <operation name="CheckIfProcessed">
      <participant name="LightweightJDBCAdapterQuery"/>
      <output message="LightweightJDBCAdapterTypeInputMessage">
        <assign to="param1" from="/ProcessData/current_filename"/>
        <assign to="paramtype1">String</assign>
        <assign to="pool">oraclePool</assign>
        <assign to="query_type">SELECT</assign>
        <assign to="row_name">row</assign>
        <assign to="result_name">result</assign>
        <assign to="sql">SELECT FILENAME FROM process_logs WHERE TRIM(LOWER(FILENAME)) = TRIM(LOWER(?))</assign>
        <assign to="from">#</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

    <choice name="IfNotProcessed">
      <select>
        <case ref="FILE_NOT_PROCESSED" activity="HandleNewFile"/>
      </select>
    </choice>

    <assign to="FILE_COUNT" from="number(/ProcessData/FILE_COUNT) + 1"/>

    <choice name="ContinueLoop">
      <select>
        <case ref="HAS_MORE_FILES" activity="ProcessFile"/>
      </select>
    </choice>
  </sequence>

  <sequence name="HandleNewFile">
    <assign to="archive_filename" 
            from="concat(
                    format-dateTime(current-dateTime(), 'yyyyMMdd_HHmmss_'), 
                    /ProcessData/current_filename
                  )"/>

    <operation name="ExtractFile">
      <participant name="E5FileSystem"/>
      <output message="FileSystemInputMessage">
        <assign to="Action">FS_EXTRACT</assign>
        <assign to="assignedFilename" from="/ProcessData/safe_filename"/>
        <assign to="extractionFolder">/sfg/sterlingintegrator/install/cloudwatch</assign>
        <assign to="bootstrap">false</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="/ProcessData/PrimaryDocument"/>
      </input>
    </operation>

    <operation name="LogToDB">
      <participant name="LightweightJDBCAdapterQuery"/>
      <output message="LightweightJDBCAdapterTypeInputMessage">
        <assign to="param1" from="/ProcessData/current_filename"/>
        <assign to="paramtype1">String</assign>
        <assign to="pool">oraclePool</assign>
        <assign to="query_type">OTHER</assign>
        <assign to="sql">INSERT INTO process_logs (FILENAME) VALUES(?)</assign>
        <assign to="from">#</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>

    <operation name="ArchiveFile">
      <participant name="E5FileSystem"/>
      <output message="FileSystemInputMessage">
        <assign to="Action">FS_MOVE</assign>
        <assign to="sourceFolder">/sfgdata/documents/s3temp</assign>
        <assign to="sourceFilename" from="/ProcessData/current_filename"/>
        <assign to="targetFolder">/sfgdata/documents/archive</assign>
        <assign to="targetFilename" from="/ProcessData/archive_filename"/>
        <assign to="createFolder">true</assign>
      </output>
      <input message="inmsg">
        <assign to="." from="*"/>
      </input>
    </operation>
  </sequence>

  <onFault>
    <sequence name="ErrorHandler">
      <operation name="LogError">
        <participant name="BPLogger"/>
        <output message="BPLoggerMessage">
          <assign to="logLevel">ERROR</assign>
          <assign to="message">Process Failed: [ErrorInfo]</assign>
        </output>
        <input message="inmsg">
          <assign to="." from="*"/>
        </input>
      </operation>
    </sequence>
  </onFault>

</process>